<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="ru">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.13.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Lab8 test: content</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(function() { init_search(); });
/* @license-end */
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Lab8 test<span id="projectnumber">&#160;1.0.1</span>
   </div>
   <div id="projectbrief">Demonstartion of OOP in C</div>
  </td>
    <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <span id="MSearchSelect"                onmouseover="return searchBox.OnSearchSelectShow()"                onmouseout="return searchBox.OnSearchSelectHide()">&#160;</span>
          <input type="text" id="MSearchField" value="" placeholder="Поиск" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Создано системой Doxygen 1.13.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('md__2home_2mark_2work_2kaf22_2cs1_2slides_2lab008_2content.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Загрузка...</div>
<div class="SRStatus" id="Searching">Поиск...</div>
<div class="SRStatus" id="NoMatches">Не найдено</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">content</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h2><a class="anchor" id="autotoc_md0"></a>
autotoc_md0</h2>
<p>author: Марк Анатольевич Симановский lang: ru-RU title: Занятие 8. Динамическая память institute: Кафедра Кибернетики ИИКС НИЯУ МИФИ subtitle: Информатика (Основы программирования) date: Осень 2025 theme: "Berlin" </p>
<h1><a class="anchor" id="autotoc_md1"></a>
theme: "Singapore"</h1>
<p>colortheme: "whale" mainfont: "DejaVu Sans" monofont: "DejaVu Sans Mono" monofontoptions: 'Scale=0.7' header-includes:</p><ul>
<li>\usepackage{tikz} </li>
</ul>
<h2><a class="anchor" id="autotoc_md2"></a>
- \usetikzlibrary{automata, positioning, arrows}</h2>
<h1><a class="anchor" id="autotoc_md3"></a>
Модель памяти</h1>
<h3><a class="anchor" id="autotoc_md4"></a>
Таблица символов</h3>
<p>::: columns</p>
<p>:::: {.column width=60%} </p><div class="fragment"><div class="line"><span class="comment">// main.c</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> func(){<span class="keywordflow">return</span> 0;} <span class="comment">// стат. ф-ция</span></div>
<div class="line"><span class="keywordtype">int</span> bar(){<span class="keywordflow">return</span> 1;} <span class="comment">// глоб. ф-ция</span></div>
<div class="line"><span class="keywordtype">int</span> <a class="code hl_function" href="b_8c.html#ac07863d69ae41a4e395b31f73b35fbcd">foo</a>(); <span class="comment">// декларация ф-ции</span></div>
<div class="line"><span class="keywordtype">int</span> var; <span class="comment">// глоб. переменная (неиниц.)</span></div>
<div class="line"><span class="keywordtype">int</span> digit = 2;<span class="comment">// глоб. переменная (иниц.)</span></div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">int</span> cn = 0; <span class="comment">// константа</span></div>
<div class="line"><span class="keywordtype">int</span> <a class="code hl_function" href="main_8c.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main</a>() { <span class="comment">// глоб. ф-ция    </span></div>
<div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">int</span> c2 = 0;<span class="comment">// стат. константа</span></div>
<div class="line">    <span class="keyword">static</span> <span class="keywordtype">int</span> i = 0;<span class="comment">// стат. переменная</span></div>
<div class="line">    puts(<span class="stringliteral">&quot;Hello, world&quot;</span>);</div>
<div class="line">    <a class="code hl_function" href="b_8c.html#ac07863d69ae41a4e395b31f73b35fbcd">foo</a>();<span class="keywordflow">return</span> 0;}</div>
<div class="ttc" id="ab_8c_html_ac07863d69ae41a4e395b31f73b35fbcd"><div class="ttname"><a href="b_8c.html#ac07863d69ae41a4e395b31f73b35fbcd">foo</a></div><div class="ttdeci">void foo()</div><div class="ttdef"><b>Определения</b> b.c:11</div></div>
<div class="ttc" id="amain_8c_html_ae66f6b31b5ad750f1fe042a706a4e3d4"><div class="ttname"><a href="main_8c.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main</a></div><div class="ttdeci">int main()</div><div class="ttdef"><b>Определения</b> main.c:39</div></div>
</div><!-- fragment --><p>::::</p>
<p>:::: {.column width=40%}</p>
<div class="fragment"><div class="line">nm main.o</div>
<div class="line">000000000000000b T bar</div>
<div class="line">0000000000000014 r c2.0</div>
<div class="line">0000000000000000 R cn</div>
<div class="line">0000000000000000 D digit</div>
<div class="line">                 U foo</div>
<div class="line">0000000000000000 t func</div>
<div class="line">0000000000000004 b i.1</div>
<div class="line">0000000000000016 T main</div>
<div class="line">                 U puts</div>
<div class="line">0000000000000000 B var</div>
</div><!-- fragment --><p> ::::</p>
<p>:::</p>
<h3><a class="anchor" id="autotoc_md5"></a>
Расположение</h3>
<p><img src="lab008/memory.png" alt=" " class="inline"/></p>
<h1><a class="anchor" id="autotoc_md6"></a>
Динамическая память</h1>
<h2><a class="anchor" id="autotoc_md7"></a>
Стек</h2>
<h3><a class="anchor" id="autotoc_md8"></a>
Статика</h3>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> arr[10];</div>
<div class="line"><span class="keywordtype">char</span> s[40];</div>
</div><!-- fragment --><p> "Внутри": просто смещение указателя stack pointer </p><div class="fragment"><div class="line">sub rsp, 96</div>
</div><!-- fragment --><p>Почему <b>96</b>? 4x10 + <em>8</em> + 1x40 + <em>8</em></p>
<h3><a class="anchor" id="autotoc_md9"></a>
sub rsp</h3>
<h4><a class="anchor" id="autotoc_md10"></a>
Выравнивание</h4>
<div class="fragment"><div class="line">offset = 16; <span class="comment">// машинное слово x2</span></div>
<div class="line"><span class="keywordtype">size_t</span> size_aligned = (size + (offset - 1)) &amp; ~(offset - 1);</div>
</div><!-- fragment --><h4><a class="anchor" id="autotoc_md11"></a>
Ассемблерные вставки</h4>
<p>::: columns :::: {.column width=50%} </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> *original_rsp;</div>
<div class="line"><span class="keywordtype">void</span> *ptr;</div>
<div class="line"><span class="keyword">asm</span> <span class="keyword">volatile</span> (</div>
<div class="line">    <span class="stringliteral">&quot;movq %%rsp, %0&quot;</span> </div>
<div class="line">    : <span class="stringliteral">&quot;=r&quot;</span> (original_rsp)</div>
<div class="line">);</div>
<div class="line"><span class="keyword">asm</span> <span class="keyword">volatile</span> (</div>
<div class="line">    <span class="stringliteral">&quot;subq %1, %%rsp\n&quot;</span></div>
<div class="line">    <span class="stringliteral">&quot;movq %%rsp, %0&quot;</span></div>
<div class="line">    : <span class="stringliteral">&quot;=r&quot;</span> (ptr)</div>
<div class="line">    : <span class="stringliteral">&quot;r&quot;</span> (size_aligned)</div>
<div class="line">    : <span class="stringliteral">&quot;memory&quot;</span></div>
<div class="line">);</div>
</div><!-- fragment --><p> ::::</p>
<p>:::: {.column width=50%} </p><div class="fragment"><div class="line"><span class="keywordtype">char</span> *array = (<span class="keywordtype">char</span>*)ptr;</div>
<div class="line"><span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i = 0; i &lt; size; i++) {</div>
<div class="line">    array[i] = ...;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">asm</span> <span class="keyword">volatile</span> (</div>
<div class="line">    <span class="stringliteral">&quot;movq %0, %%rsp&quot;</span> </div>
<div class="line">    :</div>
<div class="line">    : <span class="stringliteral">&quot;r&quot;</span> (original_rsp)</div>
<div class="line">    : <span class="stringliteral">&quot;memory&quot;</span></div>
<div class="line">);</div>
</div><!-- fragment --><p> ::::</p>
<p>:::</p>
<h3><a class="anchor" id="autotoc_md12"></a>
alloca</h3>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;alloca.h&gt;</span> </div>
<div class="line"><span class="comment">/* Allocate a block that will be freed when the calling function exits.  */</span></div>
<div class="line"><span class="keyword">extern</span> <span class="keywordtype">void</span> *alloca (<span class="keywordtype">size_t</span> __size);</div>
</div><!-- fragment --><p>Функция <code>alloca</code> выделяет <code>size</code> байтов памяти в <b>стеке</b>. <em>Это временное хранилище данных автоматически освобождается после выхода из функции.</em></p>
<h5><a class="anchor" id="autotoc_md13"></a>
В MSVC:</h5>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;malloc.h&gt;</span></div>
<div class="line"><span class="keywordtype">void</span> *_malloca(<span class="keywordtype">size_t</span> size);</div>
</div><!-- fragment --><h4><a class="anchor" id="autotoc_md14"></a>
alloca. Пример</h4>
<div class="fragment"><div class="line"><span class="keywordtype">int</span>* stack_array = alloca(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * n);</div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; n; ++i) {</div>
<div class="line">    stack_array[i] = ...;</div>
<div class="line">}</div>
</div><!-- fragment --><p> <em>Очистка автоматическая!</em></p>
<h3><a class="anchor" id="autotoc_md15"></a>
Variable Length Array (VLA)</h3>
<p>Возможность создать массив с размером, не известным на этапе компиляции</p>
<p>Появились в GCC с C99</p>
<h5><a class="anchor" id="autotoc_md16"></a>
MSVC</h5>
<p>НЕ ПОДДЕРЖИВАЕТ!</p>
<h4><a class="anchor" id="autotoc_md17"></a>
VLA. Пример</h4>
<p>::: columns :::: {.column width=50%} </p><div class="fragment"><div class="line"><span class="keywordtype">size_t</span> n;</div>
<div class="line"><span class="comment">// n определяется на run-time</span></div>
<div class="line">scanf(<span class="stringliteral">&quot;%zu&quot;</span>, &amp;n);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Массив переменной длины</span></div>
<div class="line"><span class="keywordtype">int</span> arr[n];</div>
</div><!-- fragment --><p> :::: :::: {.column width=50%}</p><ul>
<li>Нельзя использовать инициализаторы массивов</li>
<li>Нельзя объявлять глобальными</li>
<li>Нельзя объявлять статическими</li>
<li>Нельзя размещать в поле структуры</li>
<li>Если установлен макрос <code>__STDC_NO_VLA__</code>, то вообще ничего нельзя :::: :::</li>
</ul>
<h3><a class="anchor" id="autotoc_md18"></a>
О памяти на стеке</h3>
<ul>
<li>Быстро выделяется. Это все плюсы...</li>
<li>Малый размер. В зависимости от глубины вызова функций и объявленных переменных места может быть еще меньше</li>
<li>Принято выделять не более 1024 байтов.</li>
<li>Program received signal SIGSEGV, Segmentation fault.</li>
</ul>
<h2><a class="anchor" id="autotoc_md19"></a>
Куча</h2>
<h3><a class="anchor" id="autotoc_md20"></a>
Обобщенный указатель</h3>
<div class="fragment"><div class="line"><span class="keywordtype">void</span>*</div>
</div><!-- fragment --><p>Хранит адрес, как и любой другой указатель, но <br  />
 Тип указателя <code>void*</code> <b>НЕ</b> поддерживает арифметику по <em>стандарту</em>. <br  />
 В некоторых компиляторах эффект аналогичен типу <code>char*</code>.</p>
<h3><a class="anchor" id="autotoc_md21"></a>
Низкоуровневое выделение памяти</h3>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;unistd.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> brk(<span class="keywordtype">void</span> *end_data_segment);</div>
<div class="line"><span class="keywordtype">void</span> *sbrk(intptr_t increment);   </div>
</div><!-- fragment --><ul>
<li><code>brk</code> устанавливает конец сегмента данных в значение, указанное в аргументе end_data_segment</li>
<li><code>sbrk</code> увеличивает пространство данных программы на increment байт. Вызов sbrk с инкрементом 0 может быть использован, чтобы найти текущее местоположения прерывания программы.</li>
</ul>
<h4><a class="anchor" id="autotoc_md22"></a>
Низкоуровневое выделение памяти. sbrk</h4>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> *mem = sbrk(100);</div>
<div class="line"><span class="keywordflow">if</span> (mem == (<span class="keywordtype">void</span>*)-1) {...} <span class="comment">// ошибка</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">char</span>* a = mem;</div>
<div class="line"><span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> s = 0; s &lt; 100; ++s) {</div>
<div class="line">    a[s] = (char) s;</div>
<div class="line">}</div>
<div class="line"><span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> s = 0; s &lt; 100; ++s) {</div>
<div class="line">    printf(<span class="stringliteral">&quot;%d&quot;</span>, a[s]);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">if</span> (sbrk(-100) == (<span class="keywordtype">void</span>*)-1) {...} <span class="comment">// ошибка</span></div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md23"></a>
Шаг вперед. mmap</h3>
<p>В UNIX все есть файл, даже память </p><div class="fragment"><div class="line"><span class="preprocessor">#include &lt;unistd.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;sys/mman.h&gt;</span></div>
<div class="line"><span class="comment">//  mmap оторажает файл (устройство) на память</span></div>
<div class="line"><span class="keywordtype">void</span> * mmap(<span class="keywordtype">void</span> *start, <span class="keywordtype">size_t</span> length, <span class="keywordtype">int</span> prot , <span class="keywordtype">int</span> flags,</div>
<div class="line">     <span class="keywordtype">int</span> fd, off_t offset);</div>
<div class="line"><span class="comment">// munmap снимает их отображение  </span></div>
<div class="line"><span class="keywordtype">int</span> munmap(<span class="keywordtype">void</span> *start, <span class="keywordtype">size_t</span> length); </div>
</div><!-- fragment --><p> <em>запрос <code>length</code> байтов, начиная со смещения <code>offset</code> файла (или другого объекта), определенного файловым дескриптором <code>fd</code>, в память, начиная с адреса <code>start</code></em></p>
<h4><a class="anchor" id="autotoc_md24"></a>
Флаги</h4>
<ul>
<li>PROT<ul>
<li>PROT_EXEC исполнение</li>
<li>PROT_READ чтение</li>
<li>PROT_WRITE запись</li>
<li>PROT_NONE запрет доступа</li>
</ul>
</li>
<li>FLAGS<ul>
<li>MAP_SHARED общая память</li>
<li>MAP_PRIVATE частная память</li>
</ul>
</li>
</ul>
<h4><a class="anchor" id="autotoc_md25"></a>
Файловый дескриптор</h4>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;fcntl.h&gt;</span></div>
<div class="line"><span class="keywordtype">int</span> fd = open(<span class="stringliteral">&quot;mem.dat&quot;</span>, O_RDWR | O_CREAT, 0644);</div>
<div class="line"><span class="keywordflow">if</span> (fd == -1) {...} <span class="comment">// ошибка</span></div>
<div class="line"><span class="keywordtype">size_t</span> size = 1024 * 1024;</div>
<div class="line"><span class="keywordflow">if</span> (ftruncate(fd, size) == -1) {...} <span class="comment">// ошибка</span></div>
</div><!-- fragment --><p>Или устанавливаем <code>fd = -1</code> для запроса оперативной памяти</p>
<h4><a class="anchor" id="autotoc_md26"></a>
Использование mmap</h4>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> *mem = mmap(NULL, size, </div>
<div class="line">        PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS,</div>
<div class="line">        fd, 0);</div>
<div class="line"><span class="keywordflow">if</span> (mem == -1) {...} <span class="comment">// ошибка</span></div>
<div class="line"><span class="keywordtype">int</span> *arr = mem;</div>
<div class="line">arr[20] = 0;</div>
<div class="line"><span class="keywordflow">if</span> (munmap(mem, size) == -1) {...} <span class="comment">// ошибка</span></div>
</div><!-- fragment --><p>Удобно для разового выделения большого блока памяти и ручного управления им</p>
<h5><a class="anchor" id="autotoc_md27"></a>
В Windows</h5>
<p><code>CreateFileMapping, VirtualAlloc, VirtualFree</code></p>
<h2><a class="anchor" id="autotoc_md28"></a>
Высокоуровневое выделение памяти</h2>
<ul>
<li><code>malloc</code> memory allocation</li>
<li><code>calloc</code> clear allocation</li>
<li><code>realloc</code> reallocation</li>
<li><code>free</code></li>
</ul>
<p>Абстракция над низкоуровневыми операциями выделения памяти. Вызывает разные функции в зависимости от памяти</p>
<h3><a class="anchor" id="autotoc_md29"></a>
Malloc</h3>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;stdlib.h&gt;</span></div>
<div class="line"><span class="keywordtype">void</span> *malloc( <span class="keywordtype">size_t</span> size );</div>
</div><!-- fragment --><p>Запрашивает у менеджера памяти <code>size</code> байтов и возвращает указатель на начало блока или <code>NULL</code></p>
<h4><a class="anchor" id="autotoc_md30"></a>
Malloc</h4>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> *arr1 = malloc(4*<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));</div>
<div class="line"><span class="keywordflow">if</span> (arr1 == NULL) {...} <span class="comment">// ошибка</span></div>
<div class="line"><span class="keywordtype">int</span> *arr2 = malloc(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>[4])); <span class="comment">// еще вариант</span></div>
</div><!-- fragment --><p><em>Внутри может быть мусор!</em></p>
<h3><a class="anchor" id="autotoc_md31"></a>
Calloc</h3>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;stdlib.h&gt;</span></div>
<div class="line"><span class="keywordtype">void</span>* calloc( <span class="keywordtype">size_t</span> num, <span class="keywordtype">size_t</span> size );</div>
</div><!-- fragment --><p> Запрашивает у менеджера памяти место под <code>num</code> элементов, каждый из которых занимает по <code>size</code> байтов, инициализируя все нулем, и возвращает указатель на начало блока или <code>NULL</code></p>
<h4><a class="anchor" id="autotoc_md32"></a>
Calloc</h4>
<div class="fragment"><div class="line"><span class="keywordtype">int</span>* arr1 = calloc(4, <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));</div>
<div class="line"><span class="keywordflow">if</span> (arr1 == NULL) {...} <span class="comment">// ошибка</span></div>
<div class="line"><span class="keywordtype">int</span>* arr2 = calloc(1, <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>[4]));</div>
</div><!-- fragment --><p><em>Инициализирован нулем, но <b>особое внимание</b> при инициализации числе с плавающей запятой IEEE754 и указателей</em></p>
<h3><a class="anchor" id="autotoc_md33"></a>
Realloc</h3>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;stdlib.h&gt;</span></div>
<div class="line"><span class="keywordtype">void</span> *realloc( <span class="keywordtype">void</span> *ptr, <span class="keywordtype">size_t</span> new_size );</div>
</div><!-- fragment --><ul>
<li>Если <code>ptr==NULL</code>, то аналогично <code>malloc(new_size)</code></li>
<li>Иначе изменяет размер выделенного блока<ul>
<li>Если не удается сохранить текущий блок, выделяется новый участок памяти, данные копируются из старого, старый высвобождается</li>
</ul>
</li>
</ul>
<p>Возвращается указатель на новую память или <code>NULL</code>, если выделить не удалось</p>
<h4><a class="anchor" id="autotoc_md34"></a>
Realloc</h4>
<div class="fragment"><div class="line"><span class="keywordtype">int</span>* arr1 = realloc(NULL, <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * 4);</div>
<div class="line"><span class="keywordtype">int</span>* arr2 = realloc(arr1, <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * 4);</div>
<div class="line"><span class="keywordflow">if</span> (arr2 == NULL) {...} <span class="comment">// ошибка</span></div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md35"></a>
Free</h3>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;stdlib.h&gt;</span></div>
<div class="line"><span class="keywordtype">void</span> free( <span class="keywordtype">void</span> *ptr );</div>
</div><!-- fragment --><p> Всякая память, выделенная с помощью (m/c/re)alloc <b>должна быть</b> в итоге высвобождена с помощью free</p>
<h4><a class="anchor" id="autotoc_md36"></a>
Free</h4>
<p><code>malloc</code> как и <code>fopen</code> <em>содержит</em> ресурс. Всякий ресурс, если им удалось завладеть, в итоге обязан быть освобожден!</p>
<p>::: columns</p>
<p>:::: {.column width=50%} </p><div class="fragment"><div class="line"><span class="comment">// запрос ресурса</span></div>
<div class="line"><span class="keywordtype">int</span> *p1 = malloc(10*<span class="keyword">sizeof</span> *p1);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// освобождение ресурса</span></div>
<div class="line">free(p1);</div>
</div><!-- fragment --><p> ::::</p>
<p>:::: {.column width=50%} </p><div class="fragment"><div class="line"><span class="comment">// запрос ресурса</span></div>
<div class="line">FILE* f1 = fopen(<span class="stringliteral">&quot;file.txt&quot;</span>);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// освобождение ресурса</span></div>
<div class="line">fclose(f1);</div>
</div><!-- fragment --><p> ::::</p>
<p>:::</p>
<h3><a class="anchor" id="autotoc_md37"></a>
Выделение памяти. Примеры</h3>
<div class="fragment"><div class="line"><span class="keyword">struct </span><a class="code hl_function" href="b_8c.html#ac07863d69ae41a4e395b31f73b35fbcd">foo</a></div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> a;</div>
<div class="line">    <span class="keywordtype">long</span> b;</div>
<div class="line">};</div>
<div class="line"><span class="comment">// динамическое выделение памяти под структуру</span></div>
<div class="line"><span class="keyword">struct </span><a class="code hl_function" href="b_8c.html#ac07863d69ae41a4e395b31f73b35fbcd">foo</a> *p = malloc(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code hl_function" href="b_8c.html#ac07863d69ae41a4e395b31f73b35fbcd">foo</a>));</div>
<div class="line"><span class="comment">// под массив структур</span></div>
<div class="line"><span class="keyword">struct </span><a class="code hl_function" href="b_8c.html#ac07863d69ae41a4e395b31f73b35fbcd">foo</a> *arr = malloc(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code hl_function" href="b_8c.html#ac07863d69ae41a4e395b31f73b35fbcd">foo</a>) * N);</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md38"></a>
Выделение памяти. Flexible array</h3>
<div class="fragment"><div class="line"><span class="keyword">struct </span><a class="code hl_function" href="b_8c.html#ac07863d69ae41a4e395b31f73b35fbcd">foo</a></div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">size_t</span> N;</div>
<div class="line">    <span class="keywordtype">char</span> s[]; <span class="comment">// Обязательно последний!</span></div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="comment">// динамическое выделение памяти под структуру и ее массив</span></div>
<div class="line"><span class="keyword">struct </span><a class="code hl_function" href="b_8c.html#ac07863d69ae41a4e395b31f73b35fbcd">foo</a> *p = malloc(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code hl_function" href="b_8c.html#ac07863d69ae41a4e395b31f73b35fbcd">foo</a>) + <span class="keyword">sizeof</span>(<span class="keywordtype">char</span>) * N);</div>
<div class="line">p-&gt;N = N;</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md39"></a>
Ошибки памяти</h1>
<h2><a class="anchor" id="autotoc_md40"></a>
Ошибки</h2>
<h3><a class="anchor" id="autotoc_md41"></a>
Use after free</h3>
<div class="fragment"><div class="line"><span class="keywordtype">char</span> *ptr = malloc(100);</div>
<div class="line">sprintf(ptr, <span class="stringliteral">&quot;Important data&quot;</span>);</div>
<div class="line"> </div>
<div class="line">free(ptr); <span class="comment">// Память освобождена</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// ОШИБКА: использование после освобождения</span></div>
<div class="line"><span class="comment">// Неопределённое поведение!</span></div>
<div class="line">printf(<span class="stringliteral">&quot;Data: %s\n&quot;</span>, ptr); </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Хуже: запись после освобождения</span></div>
<div class="line">sprintf(ptr, <span class="stringliteral">&quot;New data&quot;</span>); <span class="comment">// Может повредить кучу!</span></div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md42"></a>
Double Free</h3>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> *arr1 = malloc(100);</div>
<div class="line"><span class="keywordtype">int</span> *arr2 = arr1; <span class="comment">// Два указателя на одну память</span></div>
<div class="line"> </div>
<div class="line">free(arr1);</div>
<div class="line"><span class="comment">// ... много кода ...</span></div>
<div class="line">free(arr2); <span class="comment">// ОШИБКА: то же место освобождено дважды!</span></div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md43"></a>
Memory Leak</h3>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="b_8c.html#ac07863d69ae41a4e395b31f73b35fbcd">foo</a>() {</div>
<div class="line">    malloc(1024); <span class="comment">// Утечка: не сохраняем указатель</span></div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (;;) {</div>
<div class="line">        <span class="comment">// Перезаписываем указатель, не освобождая</span></div>
<div class="line">        <span class="keywordtype">int</span>* a = malloc(1024);</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md44"></a>
Dangling pointer</h3>
<div class="fragment"><div class="line"><span class="keywordtype">int</span>* <a class="code hl_function" href="b_8c.html#ac07863d69ae41a4e395b31f73b35fbcd">foo</a>() {</div>
<div class="line">    <span class="keywordtype">int</span> local_var = 100;</div>
<div class="line">    <span class="keywordflow">return</span> &amp;local_var; </div>
<div class="line">    <span class="comment">// указатель на локальную переменную,</span></div>
<div class="line">    <span class="comment">// она уничтожится после выхода из функции</span></div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> <a class="code hl_function" href="main_8c.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main</a>() {</div>
<div class="line">    <span class="keywordtype">int</span> *p = <a class="code hl_function" href="b_8c.html#ac07863d69ae41a4e395b31f73b35fbcd">foo</a>();</div>
<div class="line">    <span class="comment">// висячий указатель</span></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md45"></a>
Отслеживание ошибок</h2>
<h3><a class="anchor" id="autotoc_md46"></a>
Valgrind против утечек</h3>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code hl_function" href="main_8c.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main</a>() {</div>
<div class="line">    malloc(100);</div>
<div class="line">}</div>
</div><!-- fragment --><div class="fragment"><div class="line">valgrind --tool=memcheck --leak-check=full -s ./a.out</div>
</div><!-- fragment --><div class="fragment"><div class="line">==173890== HEAP SUMMARY:</div>
<div class="line">==173890==     in use at exit: 100 bytes in 1 blocks</div>
<div class="line">==173890==   total heap usage: 1 allocs, 0 frees, 100 bytes allocated</div>
<div class="line">==173890== </div>
<div class="line">==173890== 100 bytes in 1 blocks are definitely lost in loss record 1 of 1</div>
<div class="line">==173890==    at 0x483EB26: malloc (vg_replace_malloc.c:446)</div>
<div class="line">==173890==    by 0x400487: main (b.c:196)</div>
<div class="line"> </div>
<div class="line">==173890== LEAK SUMMARY:</div>
<div class="line">==173890==    definitely lost: 100 bytes in 1 blocks</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md47"></a>
Санитайзер памяти</h3>
<div class="fragment"><div class="line">gcc main.c -fsanitize=address</div>
</div><!-- fragment --><div class="fragment"><div class="line">==175533==ERROR: AddressSanitizer: heap-use-after-free on address 0x7c23e25e0040</div>
<div class="line"> </div>
<div class="line">==176300==ERROR: AddressSanitizer: heap-buffer-overflow on address 0x7b7f385e0038</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md48"></a>
Элементы ООП в СИ</h1>
<p>СИ <em>не является</em> объектно-ориентированным языком.</p>
<p>Но некоторые парадигмы возможно воссоздать</p>
<h3><a class="anchor" id="autotoc_md49"></a>
Указатель на функцию</h3>
<p><b>тип_возврата</b> (* <em>имя_указателя</em>) (типы_параметров) </p><div class="fragment"><div class="line"><span class="keywordtype">int</span> sum(<span class="keywordtype">int</span> a, <span class="keywordtype">int</span> b) { <span class="keywordflow">return</span> a + b; }</div>
<div class="line"><span class="keywordtype">int</span> subtract(<span class="keywordtype">int</span> a, <span class="keywordtype">int</span> b) { <span class="keywordflow">return</span> a - b; }</div>
<div class="line"> </div>
<div class="line"><span class="comment">// указатель на функцию</span></div>
<div class="line">int (*operation)(int, int);</div>
<div class="line"><span class="comment">// Присваивание указателю адреса функции sum</span></div>
<div class="line">operation = sum;</div>
<div class="line"><span class="comment">// Вызов функции sum через указатель</span></div>
<div class="line"><span class="keywordtype">int</span> result_sum = operation(10, 5);</div>
</div><!-- fragment --><h4><a class="anchor" id="autotoc_md50"></a>
Псевдоним указателя на функцию</h4>
<div class="fragment"><div class="line"><span class="keyword">typedef</span> int (*operation_t)(int, int);</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> calc(<span class="keywordtype">int</span> a, <span class="keywordtype">int</span> b, operation_t op) {</div>
<div class="line">    <span class="keywordflow">return</span> op(a) + op(b);</div>
<div class="line">}</div>
</div><!-- fragment --><p><em>Указатель на функцию можно разместить и в структуре</em></p>
<h2><a class="anchor" id="autotoc_md51"></a>
Инкапсуляция</h2>
<p>Хотим изолировать состояние объекта от прямого доступа к его модификации</p>
<h3><a class="anchor" id="autotoc_md52"></a>
Инструменты</h3>
<ul>
<li>Ключевое слово <code>static</code> позволяет ограничить видимость функции в рамках файла</li>
<li>Forward declaration структуры в заголовочном файле с реализацией в файле исходного кода позволяет скрыть поля структуры</li>
</ul>
<h3><a class="anchor" id="autotoc_md53"></a>
Пример</h3>
<p>::: columns</p>
<p>:::: {.column width=50%} </p><div class="fragment"><div class="line"><span class="comment">// point.h</span></div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code hl_struct" href="structPoint2.html">Point2</a> <a class="code hl_typedef" href="point_8c.html#a5d369ff09fe90a1600ed47f91815dccb">point2_t</a>;</div>
<div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="point_8c.html#a54395281002daaec90cb8e4ed35ae59d">psetx</a>(<a class="code hl_typedef" href="point_8c.html#a5d369ff09fe90a1600ed47f91815dccb">point2_t</a>* p, <span class="keywordtype">float</span> <a class="code hl_variable" href="structPoint2.html#ab40b3a56d6bcfa29be01dbbd2b66403e">x</a>);</div>
<div class="line"><span class="keywordtype">float</span> <a class="code hl_function" href="point_8c.html#afc5556069d503479f75cd54d69ed854f">pgetx</a>(<a class="code hl_typedef" href="point_8c.html#a5d369ff09fe90a1600ed47f91815dccb">point2_t</a>* p);</div>
<div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="point_8c.html#acae2d9733466e1fd907871c1770f0765">psety</a>(<a class="code hl_typedef" href="point_8c.html#a5d369ff09fe90a1600ed47f91815dccb">point2_t</a>* p, <span class="keywordtype">float</span> <a class="code hl_variable" href="structPoint2.html#adecb218afe5a59fc0b13e80f3c8f5b4c">y</a>);</div>
<div class="line"><span class="keywordtype">float</span> <a class="code hl_function" href="point_8c.html#a0c77945185d6cd0d72dfdd645dc97bf5">pgety</a>(<a class="code hl_typedef" href="point_8c.html#a5d369ff09fe90a1600ed47f91815dccb">point2_t</a>* p);</div>
<div class="ttc" id="apoint_8c_html_a0c77945185d6cd0d72dfdd645dc97bf5"><div class="ttname"><a href="point_8c.html#a0c77945185d6cd0d72dfdd645dc97bf5">pgety</a></div><div class="ttdeci">int pgety(point2_t *p)</div><div class="ttdoc">Геттер ординаты точки</div><div class="ttdef"><b>Определения</b> point.c:66</div></div>
<div class="ttc" id="apoint_8c_html_a54395281002daaec90cb8e4ed35ae59d"><div class="ttname"><a href="point_8c.html#a54395281002daaec90cb8e4ed35ae59d">psetx</a></div><div class="ttdeci">void psetx(point2_t *p, int x)</div><div class="ttdoc">Сеттер абсциссы точки</div><div class="ttdef"><b>Определения</b> point.c:36</div></div>
<div class="ttc" id="apoint_8c_html_a5d369ff09fe90a1600ed47f91815dccb"><div class="ttname"><a href="point_8c.html#a5d369ff09fe90a1600ed47f91815dccb">point2_t</a></div><div class="ttdeci">struct Point2 point2_t</div><div class="ttdoc">Точка на двумерной плоскости</div></div>
<div class="ttc" id="apoint_8c_html_acae2d9733466e1fd907871c1770f0765"><div class="ttname"><a href="point_8c.html#acae2d9733466e1fd907871c1770f0765">psety</a></div><div class="ttdeci">void psety(point2_t *p, int y)</div><div class="ttdoc">Сеттер ордианты точки</div><div class="ttdef"><b>Определения</b> point.c:80</div></div>
<div class="ttc" id="apoint_8c_html_afc5556069d503479f75cd54d69ed854f"><div class="ttname"><a href="point_8c.html#afc5556069d503479f75cd54d69ed854f">pgetx</a></div><div class="ttdeci">int pgetx(point2_t *p)</div><div class="ttdoc">Геттер абсциссы точки</div><div class="ttdef"><b>Определения</b> point.c:51</div></div>
<div class="ttc" id="astructPoint2_html"><div class="ttname"><a href="structPoint2.html">Point2</a></div><div class="ttdoc">Точка на двумерной плоскости</div><div class="ttdef"><b>Определения</b> point.c:8</div></div>
<div class="ttc" id="astructPoint2_html_ab40b3a56d6bcfa29be01dbbd2b66403e"><div class="ttname"><a href="structPoint2.html#ab40b3a56d6bcfa29be01dbbd2b66403e">Point2::x</a></div><div class="ttdeci">int x</div><div class="ttdoc">абсцисса точки</div><div class="ttdef"><b>Определения</b> point.c:9</div></div>
<div class="ttc" id="astructPoint2_html_adecb218afe5a59fc0b13e80f3c8f5b4c"><div class="ttname"><a href="structPoint2.html#adecb218afe5a59fc0b13e80f3c8f5b4c">Point2::y</a></div><div class="ttdeci">int y</div><div class="ttdoc">абсцисса точки</div><div class="ttdef"><b>Определения</b> point.c:10</div></div>
</div><!-- fragment --><p> ::::</p>
<p>:::: {.column width=50%} </p><div class="fragment"><div class="line"><span class="comment">// point.c</span></div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code hl_struct" href="structPoint2.html">Point2</a> {</div>
<div class="line">    <span class="keywordtype">float</span> <a class="code hl_variable" href="structPoint2.html#ab40b3a56d6bcfa29be01dbbd2b66403e">x</a>, <a class="code hl_variable" href="structPoint2.html#adecb218afe5a59fc0b13e80f3c8f5b4c">y</a>;</div>
<div class="line">} <a class="code hl_typedef" href="point_8c.html#a5d369ff09fe90a1600ed47f91815dccb">point2_t</a>;</div>
<div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="point_8c.html#a54395281002daaec90cb8e4ed35ae59d">psetx</a>(<a class="code hl_typedef" href="point_8c.html#a5d369ff09fe90a1600ed47f91815dccb">point2_t</a>* p, <span class="keywordtype">float</span> x) {</div>
<div class="line">    <span class="keywordflow">if</span> (x &gt; 0)</div>
<div class="line">        p-&gt;<a class="code hl_variable" href="structPoint2.html#ab40b3a56d6bcfa29be01dbbd2b66403e">x</a> = x;</div>
<div class="line">}</div>
<div class="line"><span class="keywordtype">float</span> <a class="code hl_function" href="point_8c.html#afc5556069d503479f75cd54d69ed854f">pgetx</a>(<a class="code hl_typedef" href="point_8c.html#a5d369ff09fe90a1600ed47f91815dccb">point2_t</a>* p) {</div>
<div class="line">    <span class="keywordflow">return</span> p-&gt;<a class="code hl_variable" href="structPoint2.html#ab40b3a56d6bcfa29be01dbbd2b66403e">x</a>;</div>
<div class="line">}</div>
<div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="point_8c.html#acae2d9733466e1fd907871c1770f0765">psety</a>(<a class="code hl_typedef" href="point_8c.html#a5d369ff09fe90a1600ed47f91815dccb">point2_t</a>* p, <span class="keywordtype">float</span> y) {</div>
<div class="line">    p-&gt;<a class="code hl_variable" href="structPoint2.html#adecb218afe5a59fc0b13e80f3c8f5b4c">y</a> = y;}</div>
</div><!-- fragment --><p> ::::</p>
<p>:::</p>
<h2><a class="anchor" id="autotoc_md54"></a>
Наследование</h2>
<ul>
<li>Создание новых типов на основе старых для исключения дублирования кода.</li>
</ul>
<p><em>Часто применяют агрегацию вместо наследования для ослабевания связи</em></p>
<h3><a class="anchor" id="autotoc_md55"></a>
Пример</h3>
<p>::: columns</p>
<p>:::: {.column width=50%} </p><div class="fragment"><div class="line"><span class="comment">// Родитель</span></div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code hl_struct" href="structShape.html">Shape</a> {</div>
<div class="line">    <span class="keywordtype">int</span> <a class="code hl_variable" href="structShape.html#ac1bbc96c15ee1218a5bfc38cde1014fa">x</a>, <a class="code hl_variable" href="structShape.html#a1c8aa4f016736974cd3ab791ce143639">y</a>;</div>
<div class="line">} <a class="code hl_typedef" href="shape_8h.html#ae274f2f18a55b89ef5ee8b7492c91f2a">shape_t</a>;</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="shape_8c.html#ad53b3e24a14308fc4938f2dc8a92f6cd">move</a>(<a class="code hl_typedef" href="shape_8h.html#ae274f2f18a55b89ef5ee8b7492c91f2a">shape_t</a>* c, <span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y)</div>
<div class="line">{</div>
<div class="line">    c-&gt;<a class="code hl_variable" href="structShape.html#ac1bbc96c15ee1218a5bfc38cde1014fa">x</a> = x;</div>
<div class="line">    c-&gt;<a class="code hl_variable" href="structShape.html#a1c8aa4f016736974cd3ab791ce143639">y</a> = y;</div>
<div class="line">}</div>
<div class="ttc" id="ashape_8c_html_ad53b3e24a14308fc4938f2dc8a92f6cd"><div class="ttname"><a href="shape_8c.html#ad53b3e24a14308fc4938f2dc8a92f6cd">move</a></div><div class="ttdeci">void move(shape_t *c, int x, int y)</div><div class="ttdoc">Метод для смещения Фигуры в новый центр</div><div class="ttdef"><b>Определения</b> shape.c:36</div></div>
<div class="ttc" id="ashape_8h_html_ae274f2f18a55b89ef5ee8b7492c91f2a"><div class="ttname"><a href="shape_8h.html#ae274f2f18a55b89ef5ee8b7492c91f2a">shape_t</a></div><div class="ttdeci">struct Shape shape_t</div><div class="ttdoc">Абстрактная Фигура</div><div class="ttdef"><b>Определения</b> shape.h:17</div></div>
<div class="ttc" id="astructShape_html"><div class="ttname"><a href="structShape.html">Shape</a></div><div class="ttdoc">Абстрактная Фигура</div><div class="ttdef"><b>Определения</b> shape.h:47</div></div>
<div class="ttc" id="astructShape_html_a1c8aa4f016736974cd3ab791ce143639"><div class="ttname"><a href="structShape.html#a1c8aa4f016736974cd3ab791ce143639">Shape::y</a></div><div class="ttdeci">int y</div><div class="ttdoc">Ордината центра фигуры</div><div class="ttdef"><b>Определения</b> shape.h:50</div></div>
<div class="ttc" id="astructShape_html_ac1bbc96c15ee1218a5bfc38cde1014fa"><div class="ttname"><a href="structShape.html#ac1bbc96c15ee1218a5bfc38cde1014fa">Shape::x</a></div><div class="ttdeci">int x</div><div class="ttdoc">Абсцисса центра фигуры</div><div class="ttdef"><b>Определения</b> shape.h:49</div></div>
</div><!-- fragment --><p> ::::</p>
<p>:::: {.column width=50%} </p><div class="fragment"><div class="line"><span class="comment">// наследники</span></div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code hl_struct" href="structCircle.html">Circle</a> {</div>
<div class="line">    <a class="code hl_typedef" href="shape_8h.html#ae274f2f18a55b89ef5ee8b7492c91f2a">shape_t</a> <a class="code hl_variable" href="structCircle.html#a014f69f09ae324753f1b5d9b6ce0a1ce">base</a>;</div>
<div class="line">    <span class="keywordtype">int</span> <a class="code hl_variable" href="structCircle.html#a897ad7e556f1e90142093c69079d8b05">radius</a>;</div>
<div class="line">} <a class="code hl_typedef" href="circle_8h.html#ab800d4e1144fd90877a6134a1467b31a">circle_t</a>;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code hl_struct" href="structRect.html">Rect</a> {</div>
<div class="line">    <a class="code hl_typedef" href="shape_8h.html#ae274f2f18a55b89ef5ee8b7492c91f2a">shape_t</a> <a class="code hl_variable" href="structRect.html#a082e33824aa7921419cd9c518a223c2e">base</a>;</div>
<div class="line">    <span class="keywordtype">int</span> <a class="code hl_variable" href="structRect.html#a36b6c8bb15c7706c3b2b3e91345e11f8">w</a>, <a class="code hl_variable" href="structRect.html#af9111a21106ba65952da60320ea91df6">h</a>;</div>
<div class="line">} <a class="code hl_typedef" href="rect_8h.html#ae613c697c4133ca8304cfcb50507eac3">rect_t</a>;</div>
<div class="ttc" id="acircle_8h_html_ab800d4e1144fd90877a6134a1467b31a"><div class="ttname"><a href="circle_8h.html#ab800d4e1144fd90877a6134a1467b31a">circle_t</a></div><div class="ttdeci">struct Circle circle_t</div><div class="ttdoc">Круг</div></div>
<div class="ttc" id="arect_8h_html_ae613c697c4133ca8304cfcb50507eac3"><div class="ttname"><a href="rect_8h.html#ae613c697c4133ca8304cfcb50507eac3">rect_t</a></div><div class="ttdeci">struct Rect rect_t</div><div class="ttdoc">Прямоугольник.</div></div>
<div class="ttc" id="astructCircle_html"><div class="ttname"><a href="structCircle.html">Circle</a></div><div class="ttdoc">Круг</div><div class="ttdef"><b>Определения</b> circle.h:10</div></div>
<div class="ttc" id="astructCircle_html_a014f69f09ae324753f1b5d9b6ce0a1ce"><div class="ttname"><a href="structCircle.html#a014f69f09ae324753f1b5d9b6ce0a1ce">Circle::base</a></div><div class="ttdeci">shape_t base</div><div class="ttdoc">Родитель (абстрактная фигура)</div><div class="ttdef"><b>Определения</b> circle.h:11</div></div>
<div class="ttc" id="astructCircle_html_a897ad7e556f1e90142093c69079d8b05"><div class="ttname"><a href="structCircle.html#a897ad7e556f1e90142093c69079d8b05">Circle::radius</a></div><div class="ttdeci">int radius</div><div class="ttdoc">Радиус круга</div><div class="ttdef"><b>Определения</b> circle.h:12</div></div>
<div class="ttc" id="astructRect_html"><div class="ttname"><a href="structRect.html">Rect</a></div><div class="ttdoc">Прямоугольник.</div><div class="ttdef"><b>Определения</b> rect.h:12</div></div>
<div class="ttc" id="astructRect_html_a082e33824aa7921419cd9c518a223c2e"><div class="ttname"><a href="structRect.html#a082e33824aa7921419cd9c518a223c2e">Rect::base</a></div><div class="ttdeci">shape_t base</div><div class="ttdoc">Родитель (абстрактная фигура)</div><div class="ttdef"><b>Определения</b> rect.h:13</div></div>
<div class="ttc" id="astructRect_html_a36b6c8bb15c7706c3b2b3e91345e11f8"><div class="ttname"><a href="structRect.html#a36b6c8bb15c7706c3b2b3e91345e11f8">Rect::w</a></div><div class="ttdeci">int w</div><div class="ttdoc">Ширина прямоугольника</div><div class="ttdef"><b>Определения</b> rect.h:14</div></div>
<div class="ttc" id="astructRect_html_af9111a21106ba65952da60320ea91df6"><div class="ttname"><a href="structRect.html#af9111a21106ba65952da60320ea91df6">Rect::h</a></div><div class="ttdeci">int h</div><div class="ttdoc">Высота прямоугольника</div><div class="ttdef"><b>Определения</b> rect.h:15</div></div>
</div><!-- fragment --><p>::::</p>
<p>:::</p>
<h4><a class="anchor" id="autotoc_md56"></a>
Пример</h4>
<p>::: columns</p>
<p>:::: {.column width=50%} </p><div class="fragment"><div class="line"><a class="code hl_typedef" href="rect_8h.html#ae613c697c4133ca8304cfcb50507eac3">rect_t</a>* <a class="code hl_function" href="rect_8c.html#aa5c8547a3c5ba804e4d4e527553df165">rect_create</a>(<span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y, <span class="keywordtype">int</span> w, <span class="keywordtype">int</span> h) {</div>
<div class="line">    <a class="code hl_typedef" href="rect_8h.html#ae613c697c4133ca8304cfcb50507eac3">rect_t</a>* rect = malloc(<span class="keyword">sizeof</span>(<a class="code hl_typedef" href="rect_8h.html#ae613c697c4133ca8304cfcb50507eac3">rect_t</a>)); </div>
<div class="line">    rect-&gt;<a class="code hl_variable" href="structRect.html#a082e33824aa7921419cd9c518a223c2e">base</a>.<a class="code hl_variable" href="structShape.html#ac1bbc96c15ee1218a5bfc38cde1014fa">x</a> = x; rect-&gt;<a class="code hl_variable" href="structRect.html#a082e33824aa7921419cd9c518a223c2e">base</a>.<a class="code hl_variable" href="structShape.html#a1c8aa4f016736974cd3ab791ce143639">y</a> = y;</div>
<div class="line">    rect-&gt;<a class="code hl_variable" href="structRect.html#a36b6c8bb15c7706c3b2b3e91345e11f8">w</a> = w; rect-&gt;<a class="code hl_variable" href="structRect.html#af9111a21106ba65952da60320ea91df6">h</a> = h;</div>
<div class="line">    <span class="keywordflow">return</span> rect;</div>
<div class="line">}</div>
<div class="line"><a class="code hl_typedef" href="circle_8h.html#ab800d4e1144fd90877a6134a1467b31a">circle_t</a>* <a class="code hl_function" href="circle_8c.html#a2ab76dac5bd2421190ec375e04777013">circle_create</a>(<span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y, <span class="keywordtype">int</span> radius) {</div>
<div class="line">    <a class="code hl_typedef" href="circle_8h.html#ab800d4e1144fd90877a6134a1467b31a">circle_t</a>* circle = malloc(<span class="keyword">sizeof</span>(<a class="code hl_typedef" href="circle_8h.html#ab800d4e1144fd90877a6134a1467b31a">circle_t</a>)); </div>
<div class="line">    circle-&gt;<a class="code hl_variable" href="structCircle.html#a014f69f09ae324753f1b5d9b6ce0a1ce">base</a>.<a class="code hl_variable" href="structShape.html#ac1bbc96c15ee1218a5bfc38cde1014fa">x</a> = x; circle-&gt;<a class="code hl_variable" href="structCircle.html#a014f69f09ae324753f1b5d9b6ce0a1ce">base</a>.<a class="code hl_variable" href="structShape.html#a1c8aa4f016736974cd3ab791ce143639">y</a> = y;</div>
<div class="line">    circle-&gt;<a class="code hl_variable" href="structCircle.html#a897ad7e556f1e90142093c69079d8b05">radius</a> = radius;</div>
<div class="line">    <span class="keywordflow">return</span> circle;</div>
<div class="line">}</div>
<div class="ttc" id="acircle_8c_html_a2ab76dac5bd2421190ec375e04777013"><div class="ttname"><a href="circle_8c.html#a2ab76dac5bd2421190ec375e04777013">circle_create</a></div><div class="ttdeci">circle_t * circle_create(int x, int y, int radius)</div><div class="ttdoc">Конструктор для круга</div><div class="ttdef"><b>Определения</b> circle.c:41</div></div>
<div class="ttc" id="arect_8c_html_aa5c8547a3c5ba804e4d4e527553df165"><div class="ttname"><a href="rect_8c.html#aa5c8547a3c5ba804e4d4e527553df165">rect_create</a></div><div class="ttdeci">rect_t * rect_create(int x, int y, int w, int h)</div><div class="ttdoc">Конструктор прямоугольника. Выделяет память под новую фигуру и возвразает указатель на нее или NULL.</div><div class="ttdef"><b>Определения</b> rect.c:27</div></div>
</div><!-- fragment --><p> ::::</p>
<p>:::</p>
<h4><a class="anchor" id="autotoc_md57"></a>
Пример</h4>
<p>::: columns</p>
<p>:::: {.column width=50%} </p><div class="fragment"><div class="line"><span class="comment">// создание объектов-наслдеников</span></div>
<div class="line"><a class="code hl_typedef" href="circle_8h.html#ab800d4e1144fd90877a6134a1467b31a">circle_t</a>* c = <a class="code hl_function" href="circle_8c.html#a2ab76dac5bd2421190ec375e04777013">circle_create</a>(1, 1, 2);</div>
<div class="line"><a class="code hl_typedef" href="rect_8h.html#ae613c697c4133ca8304cfcb50507eac3">rect_t</a>* r = <a class="code hl_function" href="rect_8c.html#aa5c8547a3c5ba804e4d4e527553df165">rect_create</a>(1, 1, 2, 3);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// использование общего кода</span></div>
<div class="line"><a class="code hl_function" href="shape_8c.html#ad53b3e24a14308fc4938f2dc8a92f6cd">move</a>((<a class="code hl_typedef" href="shape_8h.html#ae274f2f18a55b89ef5ee8b7492c91f2a">shape_t</a>*)c, 2, 2);</div>
<div class="line"><a class="code hl_function" href="shape_8c.html#ad53b3e24a14308fc4938f2dc8a92f6cd">move</a>((<a class="code hl_typedef" href="shape_8h.html#ae274f2f18a55b89ef5ee8b7492c91f2a">shape_t</a>*)r, 2, 4);</div>
</div><!-- fragment --><p> ::::</p>
<p>:::</p>
<h2><a class="anchor" id="autotoc_md58"></a>
Полиморфизм</h2>
<ul>
<li>Способность использования одного имени для работы с объектами разных типов</li>
</ul>
<h3><a class="anchor" id="autotoc_md59"></a>
Пример. Абстрактная функция</h3>
<div class="fragment"><div class="line"><span class="keyword">struct </span><a class="code hl_struct" href="structShape.html">Shape</a>;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">typedef</span> void (*<a class="code hl_typedef" href="shape_8h.html#a2cdf5833e86ef273daad8e71bf4322d3">draw_func_t</a>)(<span class="keyword">const</span> <span class="keyword">struct </span><a class="code hl_struct" href="structShape.html">Shape</a>*);</div>
<div class="line"> </div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code hl_struct" href="structShape.html">Shape</a> {</div>
<div class="line">    <span class="keywordtype">int</span> <a class="code hl_variable" href="structShape.html#ac1bbc96c15ee1218a5bfc38cde1014fa">x</a>, <a class="code hl_variable" href="structShape.html#a1c8aa4f016736974cd3ab791ce143639">y</a>;</div>
<div class="line">    <a class="code hl_typedef" href="shape_8h.html#a2cdf5833e86ef273daad8e71bf4322d3">draw_func_t</a> <a class="code hl_function" href="shape_8c.html#aeac78244a8b30ffee41ae0ac60356bd7">draw</a>; <span class="comment">// абстрактная функция</span></div>
<div class="line">} <a class="code hl_typedef" href="shape_8h.html#ae274f2f18a55b89ef5ee8b7492c91f2a">shape_t</a>;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// полиморфная обертка</span></div>
<div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="shape_8c.html#aeac78244a8b30ffee41ae0ac60356bd7">draw</a> (<span class="keyword">const</span> <a class="code hl_typedef" href="shape_8h.html#ae274f2f18a55b89ef5ee8b7492c91f2a">shape_t</a>* c) {</div>
<div class="line">    c-&gt;<a class="code hl_variable" href="structShape.html#adad5c280113a8535a6797a11b55f783a">draw</a>(c);</div>
<div class="line">}</div>
<div class="ttc" id="ashape_8c_html_aeac78244a8b30ffee41ae0ac60356bd7"><div class="ttname"><a href="shape_8c.html#aeac78244a8b30ffee41ae0ac60356bd7">draw</a></div><div class="ttdeci">void draw(const shape_t *c)</div><div class="ttdoc">Метод для отрисовки Фигуры</div><div class="ttdef"><b>Определения</b> shape.c:48</div></div>
<div class="ttc" id="ashape_8h_html_a2cdf5833e86ef273daad8e71bf4322d3"><div class="ttname"><a href="shape_8h.html#a2cdf5833e86ef273daad8e71bf4322d3">draw_func_t</a></div><div class="ttdeci">void(* draw_func_t)(const struct Shape *)</div><div class="ttdoc">Тип функции для отрисовки абстрактной фигуры</div><div class="ttdef"><b>Определения</b> shape.h:24</div></div>
<div class="ttc" id="astructShape_html_adad5c280113a8535a6797a11b55f783a"><div class="ttname"><a href="structShape.html#adad5c280113a8535a6797a11b55f783a">Shape::draw</a></div><div class="ttdeci">draw_func_t draw</div><div class="ttdef"><b>Определения</b> d.c:10</div></div>
</div><!-- fragment --><h4><a class="anchor" id="autotoc_md60"></a>
Пример. Реализация 1</h4>
<div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> circle_draw(<span class="keyword">const</span> <a class="code hl_typedef" href="shape_8h.html#ae274f2f18a55b89ef5ee8b7492c91f2a">shape_t</a>* shape) {</div>
<div class="line">    <span class="keyword">const</span> <a class="code hl_typedef" href="circle_8h.html#ab800d4e1144fd90877a6134a1467b31a">circle_t</a>* circle = (<span class="keyword">const</span> <a class="code hl_typedef" href="circle_8h.html#ab800d4e1144fd90877a6134a1467b31a">circle_t</a>*)shape;</div>
<div class="line">    printf(<span class="stringliteral">&quot;Circle at (%d, %d), R=%d\n&quot;</span>, </div>
<div class="line">           circle-&gt;<a class="code hl_variable" href="structCircle.html#a014f69f09ae324753f1b5d9b6ce0a1ce">base</a>.<a class="code hl_variable" href="structShape.html#ac1bbc96c15ee1218a5bfc38cde1014fa">x</a>, circle-&gt;<a class="code hl_variable" href="structCircle.html#a014f69f09ae324753f1b5d9b6ce0a1ce">base</a>.<a class="code hl_variable" href="structShape.html#a1c8aa4f016736974cd3ab791ce143639">y</a>, circle-&gt;<a class="code hl_variable" href="structCircle.html#a897ad7e556f1e90142093c69079d8b05">radius</a>);</div>
<div class="line">}</div>
<div class="line"><a class="code hl_typedef" href="circle_8h.html#ab800d4e1144fd90877a6134a1467b31a">circle_t</a>* <a class="code hl_function" href="circle_8c.html#a2ab76dac5bd2421190ec375e04777013">circle_create</a>(<span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y, <span class="keywordtype">int</span> radius) {</div>
<div class="line">    <a class="code hl_typedef" href="circle_8h.html#ab800d4e1144fd90877a6134a1467b31a">circle_t</a>* circle = malloc(<span class="keyword">sizeof</span>(<a class="code hl_typedef" href="circle_8h.html#ab800d4e1144fd90877a6134a1467b31a">circle_t</a>)); </div>
<div class="line">    circle-&gt;<a class="code hl_variable" href="structCircle.html#a014f69f09ae324753f1b5d9b6ce0a1ce">base</a>.<a class="code hl_variable" href="structShape.html#ac1bbc96c15ee1218a5bfc38cde1014fa">x</a> = x; circle-&gt;<a class="code hl_variable" href="structCircle.html#a014f69f09ae324753f1b5d9b6ce0a1ce">base</a>.<a class="code hl_variable" href="structShape.html#a1c8aa4f016736974cd3ab791ce143639">y</a> = y;</div>
<div class="line">    circle-&gt;<a class="code hl_variable" href="structCircle.html#a014f69f09ae324753f1b5d9b6ce0a1ce">base</a>.<a class="code hl_variable" href="structShape.html#adad5c280113a8535a6797a11b55f783a">draw</a> = circle_draw; <span class="comment">// установка реализации</span></div>
<div class="line">    circle-&gt;<a class="code hl_variable" href="structCircle.html#a897ad7e556f1e90142093c69079d8b05">radius</a> = radius;</div>
<div class="line">    <span class="keywordflow">return</span> circle;</div>
<div class="line">}</div>
</div><!-- fragment --><h4><a class="anchor" id="autotoc_md61"></a>
Пример. Реализация 2</h4>
<div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> rect_draw(<span class="keyword">const</span> <a class="code hl_typedef" href="shape_8h.html#ae274f2f18a55b89ef5ee8b7492c91f2a">shape_t</a>* shape) {</div>
<div class="line">    <span class="keyword">const</span> <a class="code hl_typedef" href="rect_8h.html#ae613c697c4133ca8304cfcb50507eac3">rect_t</a>* rect = (<span class="keyword">const</span> <a class="code hl_typedef" href="rect_8h.html#ae613c697c4133ca8304cfcb50507eac3">rect_t</a>*)shape;</div>
<div class="line">    printf(<span class="stringliteral">&quot;Rect at (%d, %d), W=%d, H=%d\n&quot;</span>, </div>
<div class="line">           rect-&gt;<a class="code hl_variable" href="structRect.html#a082e33824aa7921419cd9c518a223c2e">base</a>.<a class="code hl_variable" href="structShape.html#ac1bbc96c15ee1218a5bfc38cde1014fa">x</a>, rect-&gt;<a class="code hl_variable" href="structRect.html#a082e33824aa7921419cd9c518a223c2e">base</a>.<a class="code hl_variable" href="structShape.html#a1c8aa4f016736974cd3ab791ce143639">y</a>, rect-&gt;<a class="code hl_variable" href="structRect.html#a36b6c8bb15c7706c3b2b3e91345e11f8">w</a>, rect-&gt;<a class="code hl_variable" href="structRect.html#af9111a21106ba65952da60320ea91df6">h</a>);</div>
<div class="line">}</div>
<div class="line"><a class="code hl_typedef" href="rect_8h.html#ae613c697c4133ca8304cfcb50507eac3">rect_t</a>* <a class="code hl_function" href="rect_8c.html#aa5c8547a3c5ba804e4d4e527553df165">rect_create</a>(<span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y, <span class="keywordtype">int</span> w, <span class="keywordtype">int</span> h) {</div>
<div class="line">    <a class="code hl_typedef" href="rect_8h.html#ae613c697c4133ca8304cfcb50507eac3">rect_t</a>* circle = malloc(<span class="keyword">sizeof</span>(<a class="code hl_typedef" href="rect_8h.html#ae613c697c4133ca8304cfcb50507eac3">rect_t</a>)); </div>
<div class="line">    circle-&gt;<a class="code hl_variable" href="structRect.html#a082e33824aa7921419cd9c518a223c2e">base</a>.<a class="code hl_variable" href="structShape.html#ac1bbc96c15ee1218a5bfc38cde1014fa">x</a> = x; circle-&gt;<a class="code hl_variable" href="structRect.html#a082e33824aa7921419cd9c518a223c2e">base</a>.<a class="code hl_variable" href="structShape.html#a1c8aa4f016736974cd3ab791ce143639">y</a> = y;</div>
<div class="line">    circle-&gt;<a class="code hl_variable" href="structRect.html#a082e33824aa7921419cd9c518a223c2e">base</a>.<a class="code hl_variable" href="structShape.html#adad5c280113a8535a6797a11b55f783a">draw</a> = rect_draw; <span class="comment">// установка реализации</span></div>
<div class="line">    circle-&gt;<a class="code hl_variable" href="structRect.html#a36b6c8bb15c7706c3b2b3e91345e11f8">w</a> = w; circle-&gt;<a class="code hl_variable" href="structRect.html#af9111a21106ba65952da60320ea91df6">h</a> = h;</div>
<div class="line">    <span class="keywordflow">return</span> circle;</div>
<div class="line">}</div>
</div><!-- fragment --><h4><a class="anchor" id="autotoc_md62"></a>
Пример. Использование полиморфной обертки</h4>
<div class="fragment"><div class="line"><span class="keyword">const</span> <a class="code hl_typedef" href="circle_8h.html#ab800d4e1144fd90877a6134a1467b31a">circle_t</a>* c = <a class="code hl_function" href="circle_8c.html#a2ab76dac5bd2421190ec375e04777013">circle_create</a>(1, 1, 2);</div>
<div class="line"><span class="keyword">const</span> <a class="code hl_typedef" href="rect_8h.html#ae613c697c4133ca8304cfcb50507eac3">rect_t</a>* r = <a class="code hl_function" href="rect_8c.html#aa5c8547a3c5ba804e4d4e527553df165">rect_create</a>(1, 1, 2, 3);</div>
<div class="line"> </div>
<div class="line"><a class="code hl_function" href="shape_8c.html#ad53b3e24a14308fc4938f2dc8a92f6cd">move</a>((<a class="code hl_typedef" href="shape_8h.html#ae274f2f18a55b89ef5ee8b7492c91f2a">shape_t</a>*)c, 2, 2);</div>
<div class="line"><a class="code hl_function" href="shape_8c.html#aeac78244a8b30ffee41ae0ac60356bd7">draw</a>((<span class="keyword">const</span> <a class="code hl_typedef" href="shape_8h.html#ae274f2f18a55b89ef5ee8b7492c91f2a">shape_t</a>*)c);</div>
<div class="line"><a class="code hl_function" href="shape_8c.html#aeac78244a8b30ffee41ae0ac60356bd7">draw</a>((<span class="keyword">const</span> <a class="code hl_typedef" href="shape_8h.html#ae274f2f18a55b89ef5ee8b7492c91f2a">shape_t</a>*)r);</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md63"></a>
Таблица функций</h3>
<p>Общий набор указателей на функции для объектов одного типа</p>
<p>::: columns :::: {.column width=60%} </p><div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code hl_struct" href="structShape.html">Shape</a> <a class="code hl_typedef" href="shape_8h.html#ae274f2f18a55b89ef5ee8b7492c91f2a">shape_t</a>;</div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code hl_struct" href="structShapeVTable.html">ShapeVTable</a> <a class="code hl_typedef" href="shape_8h.html#a46ae5e898b3cc9b5374d5160948f22b7">vft_shape_t</a>;</div>
<div class="line"><span class="keyword">struct </span><a class="code hl_struct" href="structShapeVTable.html">ShapeVTable</a> {</div>
<div class="line">    void (*<a class="code hl_function" href="shape_8c.html#aeac78244a8b30ffee41ae0ac60356bd7">draw</a>)(<span class="keyword">const</span> <a class="code hl_typedef" href="shape_8h.html#ae274f2f18a55b89ef5ee8b7492c91f2a">shape_t</a>*);</div>
<div class="line">    void (*<a class="code hl_function" href="shape_8c.html#ad53b3e24a14308fc4938f2dc8a92f6cd">move</a>)(<a class="code hl_typedef" href="shape_8h.html#ae274f2f18a55b89ef5ee8b7492c91f2a">shape_t</a>*, int, int);</div>
<div class="line">};</div>
<div class="line"><span class="keyword">struct </span><a class="code hl_struct" href="structShape.html">Shape</a> {</div>
<div class="line">    <a class="code hl_typedef" href="shape_8h.html#a46ae5e898b3cc9b5374d5160948f22b7">vft_shape_t</a>* <a class="code hl_variable" href="structShape.html#aca422a66d187a8c539aa62ba50650f05">vtable</a>;</div>
<div class="line">    <span class="keywordtype">int</span> <a class="code hl_variable" href="structShape.html#ac1bbc96c15ee1218a5bfc38cde1014fa">x</a>, <a class="code hl_variable" href="structShape.html#a1c8aa4f016736974cd3ab791ce143639">y</a>;</div>
<div class="line">};</div>
<div class="ttc" id="ashape_8h_html_a46ae5e898b3cc9b5374d5160948f22b7"><div class="ttname"><a href="shape_8h.html#a46ae5e898b3cc9b5374d5160948f22b7">vft_shape_t</a></div><div class="ttdeci">struct ShapeVTable vft_shape_t</div><div class="ttdoc">Таблица виртуальных функций Фигуры</div><div class="ttdef"><b>Определения</b> shape.h:18</div></div>
<div class="ttc" id="astructShapeVTable_html"><div class="ttname"><a href="structShapeVTable.html">ShapeVTable</a></div><div class="ttdoc">Таблица виртуальных функций Фигуры</div><div class="ttdef"><b>Определения</b> shape.h:37</div></div>
<div class="ttc" id="astructShape_html_aca422a66d187a8c539aa62ba50650f05"><div class="ttname"><a href="structShape.html#aca422a66d187a8c539aa62ba50650f05">Shape::vtable</a></div><div class="ttdeci">vft_shape_t * vtable</div><div class="ttdoc">Таблица виртуальный функций</div><div class="ttdef"><b>Определения</b> shape.h:48</div></div>
</div><!-- fragment --><p> ::::</p>
<p>:::: {.column width=40%} </p><div class="fragment"><div class="line"><span class="comment">// обертки</span></div>
<div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="shape_8c.html#aeac78244a8b30ffee41ae0ac60356bd7">draw</a> (<span class="keyword">const</span> <a class="code hl_typedef" href="shape_8h.html#ae274f2f18a55b89ef5ee8b7492c91f2a">shape_t</a>* c) {</div>
<div class="line">    c-&gt;<a class="code hl_variable" href="structShape.html#aca422a66d187a8c539aa62ba50650f05">vtable</a>-&gt;<a class="code hl_variable" href="structShapeVTable.html#a5fe156a2ec08898cd831ce08b9c9eb63">draw</a>(c);</div>
<div class="line">}</div>
<div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="shape_8c.html#ad53b3e24a14308fc4938f2dc8a92f6cd">move</a>(<a class="code hl_typedef" href="shape_8h.html#ae274f2f18a55b89ef5ee8b7492c91f2a">shape_t</a>* c, </div>
<div class="line">    <span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y) {</div>
<div class="line">    c-&gt;<a class="code hl_variable" href="structShape.html#aca422a66d187a8c539aa62ba50650f05">vtable</a>-&gt;<a class="code hl_variable" href="structShapeVTable.html#a6cab38b45c50a0aa0e9c04ecff73bf1b">move</a>(c, x, y);</div>
<div class="line">}</div>
<div class="ttc" id="astructShapeVTable_html_a5fe156a2ec08898cd831ce08b9c9eb63"><div class="ttname"><a href="structShapeVTable.html#a5fe156a2ec08898cd831ce08b9c9eb63">ShapeVTable::draw</a></div><div class="ttdeci">draw_func_t draw</div><div class="ttdef"><b>Определения</b> shape.h:38</div></div>
<div class="ttc" id="astructShapeVTable_html_a6cab38b45c50a0aa0e9c04ecff73bf1b"><div class="ttname"><a href="structShapeVTable.html#a6cab38b45c50a0aa0e9c04ecff73bf1b">ShapeVTable::move</a></div><div class="ttdeci">move_func_t move</div><div class="ttdef"><b>Определения</b> shape.h:39</div></div>
</div><!-- fragment --><p> ::::</p>
<p>:::</p>
<h4><a class="anchor" id="autotoc_md64"></a>
Пример. Новый инициализатор</h4>
<p>::: columns</p>
<p>:::: {.column width=50%} </p><div class="fragment"><div class="line"><span class="comment">// circle.c</span></div>
<div class="line"><span class="keyword">static</span> <a class="code hl_typedef" href="shape_8h.html#a46ae5e898b3cc9b5374d5160948f22b7">vft_shape_t</a> circle_vtable = {</div>
<div class="line">    circle_draw, <span class="comment">// своя реализация </span></div>
<div class="line">    <a class="code hl_function" href="shape_8c.html#aeaa0675a0fcc7fac6f0f93c4baf07f61">shape_move</a> <span class="comment">// общий</span></div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="comment">// rect.c</span></div>
<div class="line"><span class="keyword">static</span> <a class="code hl_typedef" href="shape_8h.html#a46ae5e898b3cc9b5374d5160948f22b7">vft_shape_t</a> rect_vtable = {</div>
<div class="line">    rect_draw, <span class="comment">// своя реализация</span></div>
<div class="line">    <a class="code hl_function" href="shape_8c.html#aeaa0675a0fcc7fac6f0f93c4baf07f61">shape_move</a> <span class="comment">// общий</span></div>
<div class="line">};</div>
<div class="ttc" id="ashape_8c_html_aeaa0675a0fcc7fac6f0f93c4baf07f61"><div class="ttname"><a href="shape_8c.html#aeaa0675a0fcc7fac6f0f93c4baf07f61">shape_move</a></div><div class="ttdeci">void shape_move(shape_t *c, int x, int y)</div><div class="ttdoc">Функция для смещения Фигуры в новый центр</div><div class="ttdef"><b>Определения</b> shape.c:21</div></div>
</div><!-- fragment --><p> ::::</p>
<p>:::: {.column width=50%} </p><div class="fragment"><div class="line"><a class="code hl_typedef" href="circle_8h.html#ab800d4e1144fd90877a6134a1467b31a">circle_t</a>* <a class="code hl_function" href="circle_8c.html#a2ab76dac5bd2421190ec375e04777013">circle_create</a>(<span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y, </div>
<div class="line">    <span class="keywordtype">int</span> radius) {</div>
<div class="line">    ...</div>
<div class="line">    circle-&gt;<a class="code hl_variable" href="structRect.html#a082e33824aa7921419cd9c518a223c2e">base</a>.<a class="code hl_variable" href="structShape.html#aca422a66d187a8c539aa62ba50650f05">vtable</a> =</div>
<div class="line">         &amp;circle_vtable;</div>
<div class="line">    ...</div>
<div class="line">}</div>
<div class="line"><a class="code hl_typedef" href="rect_8h.html#ae613c697c4133ca8304cfcb50507eac3">rect_t</a>* <a class="code hl_function" href="rect_8c.html#aa5c8547a3c5ba804e4d4e527553df165">rect_create</a>(<span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y,</div>
<div class="line">     <span class="keywordtype">int</span> w, <span class="keywordtype">int</span> h) {</div>
<div class="line">    ...</div>
<div class="line">    rect-&gt;<a class="code hl_variable" href="structRect.html#a082e33824aa7921419cd9c518a223c2e">base</a>.<a class="code hl_variable" href="structShape.html#aca422a66d187a8c539aa62ba50650f05">vtable</a> = </div>
<div class="line">        &amp;rect_vtable;</div>
<div class="line">    ...</div>
<div class="line">}</div>
</div><!-- fragment --><p> ::::</p>
<p>:::</p>
<h3><a class="anchor" id="autotoc_md65"></a>
Полиморфизм префикса типов. Вместо шаблонов</h3>
<div class="fragment"><div class="line"><span class="preprocessor">#define CONCAT(a, b) a##b</span></div>
<div class="line"><span class="preprocessor">#define CONCAT3(a, b, c) a##b##c</span></div>
<div class="line"><span class="preprocessor">#define METHOD(type, name) CONCAT3(type, _, name)</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define CIRCLE(type) CONCAT3(Circle, _, type)</span></div>
</div><!-- fragment --><h4><a class="anchor" id="autotoc_md66"></a>
Полиморфизм префикса типов. Вместо шаблонов</h4>
<div class="fragment"><div class="line"><span class="preprocessor">#define DECLARE_CIRCLE(type) \</span></div>
<div class="line"><span class="preprocessor">    typedef struct CONCAT(Circle_, type) CONCAT(Circle_, type); \</span></div>
<div class="line"><span class="preprocessor">    struct CONCAT(Circle_, type) { \</span></div>
<div class="line"><span class="preprocessor">        type x; \</span></div>
<div class="line"><span class="preprocessor">        type y; \</span></div>
<div class="line"><span class="preprocessor">        type radius; \</span></div>
<div class="line"><span class="preprocessor">    }; \</span></div>
<div class="line"><span class="preprocessor">    \</span></div>
<div class="line"><span class="preprocessor">    CONCAT(Circle_, type)* METHOD(type, Circle_create)(type x, type y,\</span></div>
<div class="line"><span class="preprocessor">     type radius); \</span></div>
<div class="line"><span class="preprocessor">    void METHOD(type, Circle_print)(const CONCAT(Circle_, type)* circle);</span></div>
</div><!-- fragment --><h4><a class="anchor" id="autotoc_md67"></a>
Полиморфизм префикса типов. Вместо шаблонов</h4>
<div class="fragment"><div class="line"><span class="preprocessor">#define IMPLEMENT_CIRCLE(type, format_specifier) \</span></div>
<div class="line"><span class="preprocessor">    CONCAT(Circle_, type)* METHOD(type, Circle_create)(type x, type y,\</span></div>
<div class="line"><span class="preprocessor">     type radius) { \</span></div>
<div class="line"><span class="preprocessor">        CONCAT(Circle_, type)* circle = malloc(sizeof(\</span></div>
<div class="line"><span class="preprocessor">            CONCAT(Circle_, type))); \</span></div>
<div class="line"><span class="preprocessor">        circle-&gt;x = x; \</span></div>
<div class="line"><span class="preprocessor">        circle-&gt;y = y; \</span></div>
<div class="line"><span class="preprocessor">        circle-&gt;radius = radius; \</span></div>
<div class="line"><span class="preprocessor">        return circle; \</span></div>
<div class="line"><span class="preprocessor">    } \</span></div>
</div><!-- fragment --><h4><a class="anchor" id="autotoc_md68"></a>
Полиморфизм префикса типов. Вместо шаблонов</h4>
<div class="fragment"><div class="line">\</div>
<div class="line"><span class="keywordtype">void</span> <a class="code hl_define" href="ff_01copy_8c.html#add6eab429018dc239cd6dfeba8c9fc8a">METHOD</a>(type, Circle_print)(<span class="keyword">const</span> <a class="code hl_define" href="ff_01copy_8c.html#a88fa737059e67b4b17ec980e5877361e">CONCAT</a>(Circle_, type)* circle) { \</div>
<div class="line">    printf(<span class="stringliteral">&quot;Circle(&quot;</span> #type <span class="stringliteral">&quot;): center=(&quot;</span> format_specifier <span class="stringliteral">&quot;, &quot;</span>\</div>
<div class="line">     format_specifier <span class="stringliteral">&quot;), radius=&quot;</span> format_specifier <span class="stringliteral">&quot;\n&quot;</span>, \</div>
<div class="line">           circle-&gt;x, circle-&gt;y, circle-&gt;radius); \</div>
<div class="line">}</div>
<div class="ttc" id="aff_01copy_8c_html_a88fa737059e67b4b17ec980e5877361e"><div class="ttname"><a href="ff_01copy_8c.html#a88fa737059e67b4b17ec980e5877361e">CONCAT</a></div><div class="ttdeci">#define CONCAT(a, b)</div><div class="ttdef"><b>Определения</b> ff copy.c:95</div></div>
<div class="ttc" id="aff_01copy_8c_html_add6eab429018dc239cd6dfeba8c9fc8a"><div class="ttname"><a href="ff_01copy_8c.html#add6eab429018dc239cd6dfeba8c9fc8a">METHOD</a></div><div class="ttdeci">#define METHOD(type, name)</div><div class="ttdef"><b>Определения</b> ff copy.c:98</div></div>
</div><!-- fragment --><h4><a class="anchor" id="autotoc_md69"></a>
Полиморфизм префикса типов. Пример</h4>
<div class="fragment"><div class="line"><span class="preprocessor">#define CIRCLE_CREATE(type, x, y, radius) METHOD(type, Circle_create)\</span></div>
<div class="line"><span class="preprocessor">    (x, y, radius)</span></div>
<div class="line"><span class="preprocessor">#define CIRCLE_PRINT(circle, type) METHOD(type, Circle_print)(circle)</span></div>
<div class="line"> </div>
<div class="line"><a class="code hl_define" href="ff_01copy_8c.html#ab7e6e18d34b52c70156496c4bc1ba608">DECLARE_CIRCLE</a>(<span class="keywordtype">int</span>)</div>
<div class="line"><a class="code hl_define" href="ff_01copy_8c.html#a6827f1910d910dbcc6e34f30c102eedc">IMPLEMENT_CIRCLE</a>(<span class="keywordtype">int</span>, <span class="stringliteral">&quot;%d&quot;</span>)</div>
<div class="line"><a class="code hl_define" href="ff_01copy_8c.html#ab7e6e18d34b52c70156496c4bc1ba608">DECLARE_CIRCLE</a>(<span class="keywordtype">float</span>)</div>
<div class="line"><a class="code hl_define" href="ff_01copy_8c.html#a6827f1910d910dbcc6e34f30c102eedc">IMPLEMENT_CIRCLE</a>(<span class="keywordtype">float</span>, <span class="stringliteral">&quot;%f&quot;</span>)</div>
<div class="line"> </div>
<div class="line"><a class="code hl_define" href="ff_01copy_8c.html#a7bd66b86b5fe6807df77c720f4a47491">CIRCLE</a>(<span class="keywordtype">int</span>)* circle1 = <a class="code hl_define" href="ff_01copy_8c.html#aafea4e3933366f607694f03ed0b21d01">CIRCLE_CREATE</a>(<span class="keywordtype">int</span>, 10, 20, 5);</div>
<div class="line"><a class="code hl_define" href="ff_01copy_8c.html#a7bd66b86b5fe6807df77c720f4a47491">CIRCLE</a>(<span class="keywordtype">float</span>)* circle2 = <a class="code hl_define" href="ff_01copy_8c.html#aafea4e3933366f607694f03ed0b21d01">CIRCLE_CREATE</a>(<span class="keywordtype">float</span>, 3.5f, 7.2f, 2.1f);</div>
<div class="line"> </div>
<div class="line"><a class="code hl_define" href="ff_01copy_8c.html#a84a6527f5e35173dd00ad484ba0361c2">CIRCLE_PRINT</a>(circle1, <span class="keywordtype">int</span>);</div>
<div class="ttc" id="aff_01copy_8c_html_a6827f1910d910dbcc6e34f30c102eedc"><div class="ttname"><a href="ff_01copy_8c.html#a6827f1910d910dbcc6e34f30c102eedc">IMPLEMENT_CIRCLE</a></div><div class="ttdeci">#define IMPLEMENT_CIRCLE(type, format_specifier)</div><div class="ttdef"><b>Определения</b> ff copy.c:113</div></div>
<div class="ttc" id="aff_01copy_8c_html_a7bd66b86b5fe6807df77c720f4a47491"><div class="ttname"><a href="ff_01copy_8c.html#a7bd66b86b5fe6807df77c720f4a47491">CIRCLE</a></div><div class="ttdeci">#define CIRCLE(b)</div><div class="ttdef"><b>Определения</b> ff copy.c:97</div></div>
<div class="ttc" id="aff_01copy_8c_html_a84a6527f5e35173dd00ad484ba0361c2"><div class="ttname"><a href="ff_01copy_8c.html#a84a6527f5e35173dd00ad484ba0361c2">CIRCLE_PRINT</a></div><div class="ttdeci">#define CIRCLE_PRINT(circle, type)</div><div class="ttdef"><b>Определения</b> ff copy.c:128</div></div>
<div class="ttc" id="aff_01copy_8c_html_aafea4e3933366f607694f03ed0b21d01"><div class="ttname"><a href="ff_01copy_8c.html#aafea4e3933366f607694f03ed0b21d01">CIRCLE_CREATE</a></div><div class="ttdeci">#define CIRCLE_CREATE(type, x, y, radius)</div><div class="ttdef"><b>Определения</b> ff copy.c:127</div></div>
<div class="ttc" id="aff_01copy_8c_html_ab7e6e18d34b52c70156496c4bc1ba608"><div class="ttname"><a href="ff_01copy_8c.html#ab7e6e18d34b52c70156496c4bc1ba608">DECLARE_CIRCLE</a></div><div class="ttdeci">#define DECLARE_CIRCLE(type)</div><div class="ttdef"><b>Определения</b> ff copy.c:101</div></div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md70"></a>
Generic selection</h3>
<p>С C11 в GCC появилось макро-расширение для создания общих имен для разных типов данных</p>
<div class="fragment"><div class="line"><span class="keywordtype">float</span> <a class="code hl_function" href="ff_01copy_8c.html#a0a99523630f5f9cc0399313566fb8804">pow2f</a>(<span class="keywordtype">float</span> x) {<span class="keywordflow">return</span> powf(2.0f, x);}</div>
<div class="line"><span class="keywordtype">double</span> <a class="code hl_function" href="ff_01copy_8c.html#a77be8e520ba3385065a7c0b233bfab09">pow2d</a>(<span class="keywordtype">double</span> x) {<span class="keywordflow">return</span> pow(2.0, x);}</div>
<div class="line"><span class="keywordtype">int</span> <a class="code hl_function" href="ff_01copy_8c.html#a342b41a38820dd95b5131f8abf684177">pow2i</a>(<span class="keywordtype">int</span> x) {<span class="keywordflow">return</span> 1&lt;&lt;x;}</div>
<div class="line"><span class="preprocessor">#define pow2(X) _Generic((X),     \</span></div>
<div class="line"><span class="preprocessor">    float: pow2f, \</span></div>
<div class="line"><span class="preprocessor">    double: pow2d, \</span></div>
<div class="line"><span class="preprocessor">    int: pow2i,     \</span></div>
<div class="line"><span class="preprocessor">    default: pow2d   \</span></div>
<div class="line"><span class="preprocessor">    )(X)</span></div>
<div class="line">printf(<span class="stringliteral">&quot;%e %e %e %d&quot;</span>, <a class="code hl_define" href="ff_01copy_8c.html#a949019744902704184855660869d1a35">pow2</a>(6.f), <a class="code hl_define" href="ff_01copy_8c.html#a949019744902704184855660869d1a35">pow2</a>(6.), <a class="code hl_define" href="ff_01copy_8c.html#a949019744902704184855660869d1a35">pow2</a>(6.0l), <a class="code hl_define" href="ff_01copy_8c.html#a949019744902704184855660869d1a35">pow2</a>(6));</div>
<div class="ttc" id="aff_01copy_8c_html_a0a99523630f5f9cc0399313566fb8804"><div class="ttname"><a href="ff_01copy_8c.html#a0a99523630f5f9cc0399313566fb8804">pow2f</a></div><div class="ttdeci">float pow2f(float x)</div><div class="ttdef"><b>Определения</b> ff copy.c:83</div></div>
<div class="ttc" id="aff_01copy_8c_html_a342b41a38820dd95b5131f8abf684177"><div class="ttname"><a href="ff_01copy_8c.html#a342b41a38820dd95b5131f8abf684177">pow2i</a></div><div class="ttdeci">int pow2i(int x)</div><div class="ttdef"><b>Определения</b> ff copy.c:85</div></div>
<div class="ttc" id="aff_01copy_8c_html_a77be8e520ba3385065a7c0b233bfab09"><div class="ttname"><a href="ff_01copy_8c.html#a77be8e520ba3385065a7c0b233bfab09">pow2d</a></div><div class="ttdeci">double pow2d(double x)</div><div class="ttdef"><b>Определения</b> ff copy.c:84</div></div>
<div class="ttc" id="aff_01copy_8c_html_a949019744902704184855660869d1a35"><div class="ttname"><a href="ff_01copy_8c.html#a949019744902704184855660869d1a35">pow2</a></div><div class="ttdeci">#define pow2(X)</div><div class="ttdef"><b>Определения</b> ff copy.c:87</div></div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md71"></a>
Контейнер</h3>
<h1><a class="anchor" id="autotoc_md72"></a>
Домашнее задание</h1>
<p>При аллокации кроме "полезной" памяти выделяется место под мета-информацию: размер блока памяти и указатель на следующий (и предыдущий) блок мета-информации. Это позволяет легче искать место для выжедения памяти после высвобождений "в центре"</p>
<p>Создать функции и (инкапсулированные) структуры для кастомного аллокатора.</p>
<h2><a class="anchor" id="autotoc_md73"></a>
Алло, катор 1</h2>
<ol type="1">
<li>Любой вызов функции выводит в лог текущее состояние памяти</li>
<li>Создать статичный пустой указатель на общую память. При первом вызове <code>void* my_alloc(size_t N)</code> зарезервировать общую память (напр. <code>malloc</code>ом) в 10 МБ, записать адрес ее начала в этот указатель</li>
</ol>
<h3><a class="anchor" id="autotoc_md74"></a>
Алло, катор 1</h3>
<ol type="1">
<li>Первый и последующий вызовы <code>my_alloc</code> пытаются последовательно зарезервировать место в N байт в общей памяти.</li>
<li>Вызов <code>void my_free(void* p)</code> помечает свободными для новых выделений ранее запрошенную память по указателю p, если этот указатель из общей памяти. Или паникует в лог.</li>
</ol>
<h2><a class="anchor" id="autotoc_md75"></a>
Алло, катор 2</h2>
<ol type="1">
<li>Сделать аллокатор полиморфным относительно базовой <b>ЯЧЕЙКИ</b>: <code>char</code> (по-умолчанию) и <code>uint32_t</code>, <code>uint64_t</code>, <code>uint64_t[10]</code>.</li>
<li>Функция <code>block_t* initb(size_t size, type t)</code> резервирует общую память (напр. <code>malloc</code>ом) в size <b>ЯЧЕЕК</b> типа <code>type</code>, записывает адрес ее начала в скрытое поле структуры <code>block_t</code> и возвращает указатель на структуру</li>
</ol>
<h3><a class="anchor" id="autotoc_md76"></a>
Алло, катор 2</h3>
<ol type="1">
<li>Вызов полиморфной <code>void* my_allocb(block_t* b, size_t N)</code> пытаются последовательно зарезервировать место в N байт в общей памяти блока b. Выравнивать элементы относительно <b>ЯЧЕЙКИ</b></li>
<li>Вызов полиморфной <code>void my_freeb(block_t* b, void* p)</code> помечает свободными для новых выделений ранее запрошенную память по указателю p, если этот указатель из блока общей памяти. Или паникует в лог. </li>
</ol>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Создано системой <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.13.2 </li>
  </ul>
</div>
</body>
</html>
